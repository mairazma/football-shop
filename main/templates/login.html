{% extends 'base.html' %}

{% block meta %}
<title>Login - Amaranth Sportcenter</title>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
{% endblock meta %}

{% block content %}
<div class="min-h-screen flex items-center justify-center p-8 bg-gray-50">
  <div class="max-w-md w-full">
    <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8 form-style">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Welcome Back</h2>
        <p class="text-gray-600">Sign in to <b>Amaranth Sportcenter</b></p>
      </div>

      <!-- Error Display -->
      <div id="error-container" class="hidden mb-6">
        <div class="px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700">
          <span id="error-message"></span>
        </div>
      </div>

      <form id="loginForm" class="space-y-6">
        {% csrf_token %}
        
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input 
            id="username" 
            name="username" 
            type="text" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500 transition-colors" 
            placeholder="Enter your username">
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <input 
            id="password" 
            name="password" 
            type="password" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500 transition-colors" 
            placeholder="Enter your password">
        </div>

        <div class="text-center">
          <button type="submit" id="submitButton" class="button1" style="width: 100%;">
            <span id="submitButtonText">Sign In</span>
          </button>
        </div>
      </form>

      <div class="mt-6 text-center pt-6 border-t border-gray-200">
        <p class="text-gray-500 text-sm">
          Don't have an account? 
          <a href="{% url 'main:register' %}" class="text-blue-600 hover:text-blue-700 font-medium">
            Sign Up
          </a>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
  });

  async function handleLogin(e) {
    e.preventDefault();
    
    const submitButton = document.getElementById('submitButton');
    const submitButtonText = document.getElementById('submitButtonText');
    const errorContainer = document.getElementById('error-container');
    
    submitButton.disabled = true;
    submitButtonText.textContent = 'Signing in...';
    errorContainer.classList.add('hidden');
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    try {
      const response = await fetch('/api/login/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          username: username,
          password: password
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast('Welcome Back!', 'Login successful! Redirecting...', 'success');
        
        document.cookie = `last_login=${new Date().toISOString()}; path=/`;
        
        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
      } else {
        showError(data.message || 'Invalid username or password');
        submitButton.disabled = false;
        submitButtonText.textContent = 'Sign In';
      }
    } catch (error) {
      showError('Network error occurred. Please try again.');
      submitButton.disabled = false;
      submitButtonText.textContent = 'Sign In';
    }
  }

  function showError(message) {
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    
    errorMessage.textContent = message;
    errorContainer.classList.remove('hidden');
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

<style>
  @keyframes slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  .animate-slide-in {
    animation: slide-in 0.3s ease-out;
    transition: all 0.3s ease-out;
  }
</style>

{% endblock content %}