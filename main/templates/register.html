{% extends 'base.html' %}

{% block meta %}
<title>Register - Amaranth Sportcenter</title>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
{% endblock meta %}

{% block content %}
<div class="min-h-screen flex items-center justify-center p-8 bg-gray-50">
  <div class="max-w-md w-full">
    <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8 form-style">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Join Us</h2>
        <p class="text-gray-600">Create your account at <b>Amaranth Sportcenter</b></p>
      </div>

      <!-- Error Display -->
      <div id="error-container" class="hidden mb-6">
        <!-- Errors will be inserted here -->
      </div>

      <form id="registerForm" class="space-y-6">
        {% csrf_token %}
        
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input 
            id="username" 
            name="username" 
            type="text" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500 transition-colors" 
            placeholder="Choose a username">
          <div id="username-error" class="hidden mt-1 text-sm text-red-600"></div>
        </div>

        <div>
          <label for="password1" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <input 
            id="password1" 
            name="password1" 
            type="password" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500 transition-colors" 
            placeholder="Create a password">
          <div id="password1-error" class="hidden mt-1 text-sm text-red-600"></div>
        </div>

        <div>
          <label for="password2" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
          <input 
            id="password2" 
            name="password2" 
            type="password" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500 transition-colors" 
            placeholder="Confirm your password">
          <div id="password2-error" class="hidden mt-1 text-sm text-red-600"></div>
        </div>

        <div class="text-center">
          <button type="submit" id="submitButton" class="button1" style="width: 100%;">
            <span id="submitButtonText">Create Account</span>
          </button>
        </div>
      </form>

      <div class="mt-6 text-center pt-6 border-t border-gray-200">
        <p class="text-gray-500 text-sm">
          Already have an account? 
          <a href="{% url 'main:login' %}" class="text-blue-600 hover:text-blue-700 font-medium">
            Sign In
          </a>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
  });

  async function handleRegister(e) {
    e.preventDefault();
    
    const submitButton = document.getElementById('submitButton');
    const submitButtonText = document.getElementById('submitButtonText');
    
    clearErrors();
    
    submitButton.disabled = true;
    submitButtonText.textContent = 'Creating account...';
    
    const username = document.getElementById('username').value;
    const password1 = document.getElementById('password1').value;
    const password2 = document.getElementById('password2').value;
    
    try {
      const response = await fetch('/api/register/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          username: username,
          password1: password1,
          password2: password2
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        showToast('Success!', 'Account created successfully! Redirecting to login...', 'success');
        
        setTimeout(() => {
          window.location.href = '{% url "main:login" %}';
        }, 1500);
      } else {
        displayErrors(data.errors);
        submitButton.disabled = false;
        submitButtonText.textContent = 'Create Account';
      }
    } catch (error) {
      showToast('Network Error', 'Network error occurred. Please try again.', 'error');
      submitButton.disabled = false;
      submitButtonText.textContent = 'Create Account';
    }
  }

  function displayErrors(errors) {
    const errorContainer = document.getElementById('error-container');
    errorContainer.innerHTML = '';
    errorContainer.classList.remove('hidden');
    
    const firstField = Object.keys(errors)[0];
    const firstError = errors[firstField][0];
    showToast('Registration Error', firstError, 'error');
    
    for (const [field, messages] of Object.entries(errors)) {
      const fieldErrorDiv = document.getElementById(`${field}-error`);
      if (fieldErrorDiv) {
        fieldErrorDiv.textContent = messages.join(', ');
        fieldErrorDiv.classList.remove('hidden');
      }
      
    
      messages.forEach(message => {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700 mb-2';
        errorDiv.innerHTML = `<strong>${field === '__all__' ? 'Error' : field}:</strong> ${DOMPurify.sanitize(message)}`;
        errorContainer.appendChild(errorDiv);
      });
    }
  }

  function clearErrors() {
    const errorContainer = document.getElementById('error-container');
    errorContainer.classList.add('hidden');
    errorContainer.innerHTML = '';
    
    ['username', 'password1', 'password2'].forEach(field => {
      const fieldErrorDiv = document.getElementById(`${field}-error`);
      if (fieldErrorDiv) {
        fieldErrorDiv.classList.add('hidden');
        fieldErrorDiv.textContent = '';
      }
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

<style>
  @keyframes slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  .animate-slide-in {
    animation: slide-in 0.3s ease-out;
    transition: all 0.3s ease-out;
  }
</style>

{% endblock content %}